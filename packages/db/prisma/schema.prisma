generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector", schema: "public")]
}

model Strain {
  id          String     @id @default(cuid())
  slug        String     @unique
  name        String
  type        StrainType
  thcPercent  Float?
  cbdPercent  Float?
  effects     String[]
  flavors     String[]
  description String?    @db.Text
  imageUrl    String?
  leaflyUrl   String?
  embedding   Unsupported("vector(1536)")?

  inventory  Inventory[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([effects])
}

model Inventory {
  id           String @id @default(cuid())
  strainId     String
  strain       Strain @relation(fields: [strainId], references: [id], onDelete: Cascade)
  quantity     Int
  pricePerGram Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([strainId])
}

model Cart {
  id        String     @id @default(cuid())
  sessionId String     @unique
  userId    String?    @unique // Clerk user ID - one cart per user
  items     CartItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CartItem {
  id       String @id @default(cuid())
  cartId   String
  cart     Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  strainId String
  strain   Strain @relation(fields: [strainId], references: [id], onDelete: Cascade)
  grams    Float

  @@unique([cartId, strainId])
}

model Order {
  id              String      @id @default(cuid())
  stripeSessionId String      @unique
  status          OrderStatus @default(PENDING)
  items           OrderItem[]
  totalCents      Int
  email           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id           String  @id @default(cuid())
  orderId      String
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  strainId     String?
  strain       Strain? @relation(fields: [strainId], references: [id], onDelete: SetNull)
  strainName   String
  grams        Float
  pricePerGram Float
  priceCents   Int
}

enum StrainType {
  INDICA
  SATIVA
  HYBRID
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  CANCELLED
}
